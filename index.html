<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Taro Miner Dashboard</title>
<style>
body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f0f2f5; }
h2 { margin-top: 0; }
.card { background: #fff; padding: 15px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
button { padding: 8px 12px; margin: 5px; border: none; border-radius: 5px; background-color: #007bff; color: #fff; cursor: pointer; }
button:hover { background-color: #0056b3; }
#output { white-space: pre-line; font-size: 14px; }
#welcomeForm { background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
</style>
</head>
<body>

<h2>Taro Miner Dashboard</h2>

<!-- Form Welcome / Referral -->
<div id="welcomeForm" style="display:none;">
  <p>Selamat datang! Masukkan kode referral (opsional):</p>
  <input type="text" id="referralCode" placeholder="Kode referral">
  <button onclick="submitReferral()">Lanjut</button>
</div>

<!-- Dashboard -->
<div id="dashboard" style="display:none;">
  <div class="card">
    <div>Hashrate Saya: <span id="myHashrate">--</span> H/s</div>
    <div>Hashrate Jaringan: <span id="networkHashrate">--</span> H/s</div>
    <div>Blok Saat Ini: <span id="currentBlock">--</span></div>
    <div>TRO Tertambang: <span id="minedTRO">--</span> TRO</div>
    <div>Pending Reward: <span id="pendingReward">--</span> TRO</div>
  </div>

  <div class="card">
    <button onclick="showShop()">Shop</button>
    <button onclick="showInventory()">Inventory</button>
    <button onclick="claimRewards()">Claim Reward</button>
    <button onclick="showRewardHistory()">Reward History</button>
    <button onclick="showWithdrawForm()">Withdraw</button>
    <button onclick="showWithdrawHistory()">Withdraw History</button>
  </div>
</div>

<div id="output"></div>

<script>
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbx9ycxcyrGVjexGxin_pH7HyEZF5dGb8r42nsnfoyfOpCEl1m0t_LcRTVBJbBno3ruB/exec';
let tgUser = { id: null, username: null };

// 1️⃣ Ambil ID Telegram
if (window.Telegram.WebApp) {
    tgUser.id = window.Telegram.WebApp.initDataUnsafe.user.id;
    tgUser.username = window.Telegram.WebApp.initDataUnsafe.user.username;
    checkUser();
} else {
    alert("Harap buka di Telegram WebApp untuk registrasi otomatis.");
}

// 2️⃣ Cek apakah user sudah terdaftar
async function checkUser() {
    const res = await fetchData('getUser', { telegram_id: tgUser.id });
    if (res.error) {
        document.getElementById('welcomeForm').style.display = 'block';
    } else {
        document.getElementById('dashboard').style.display = 'block';
        updateDashboard();
    }
}

// 3️⃣ Submit referral & register user
async function submitReferral() {
    const referred_by = document.getElementById('referralCode').value || '';
    const res = await fetch(`${WEBAPP_URL}?action=registerUser&telegram_id=${tgUser.id}&username=${tgUser.username}&base_hashrate=1&referred_by=${referred_by}`);
    document.getElementById('welcomeForm').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
    updateDashboard();
}

// 4️⃣ Fungsi fetch data
async function fetchData(action, params={}) {
    const url = new URL(WEBAPP_URL);
    url.searchParams.append('action', action);
    for (const key in params) url.searchParams.append(key, params[key]);
    const res = await fetch(url);
    return res.json();
}

// 5️⃣ Update Dashboard
async function updateDashboard() {
    try {
        const user = await fetchData('getUser', { telegram_id: tgUser.id });
        const network = await fetchData('getNetworkHashrate');
        const currentBlockData = await fetchData('getCurrentBlock');
        
        document.getElementById('myHashrate').textContent = user.effective_hashrate;
        document.getElementById('networkHashrate').textContent = network.total_hashrate;
        document.getElementById('currentBlock').textContent = currentBlockData.block_number + 1;
        document.getElementById('minedTRO').textContent = user.total_claimed;
        document.getElementById('pendingReward').textContent = user.unclaimed_balance;
    } catch(err) {
        console.error(err);
    }
}

// 6️⃣ Tombol interaktif (minimal)
async function showShop() {
    const items = await fetchData('listShop');
    let output = '=== SHOP ===\n';
    items.forEach(i => output += `${i.item_name} (+${i.bonus_hashrate} H/s) - ${i.price} TRO\n`);
    document.getElementById('output').textContent = output;
}

async function showInventory() {
    const inv = await fetchData('listInventory', { telegram_id: tgUser.id });
    let output = '=== INVENTORY ===\n';
    inv.forEach(i => output += `${i.item_name} x${i.qty} (+${i.bonus_hashrate} H/s)\n`);
    document.getElementById('output').textContent = output;
}

async function claimRewards() {
    await fetchData('claimReward', { telegram_id: tgUser.id });
    updateDashboard();
}

async function showRewardHistory() {
    const history = await fetchData('getRewardHistory', { telegram_id: tgUser.id });
    let output = '=== REWARD HISTORY ===\n';
    history.forEach(h => output += `Block ${h.block_number}: +${h.reward} TRO\n`);
    document.getElementById('output').textContent = output;
}

function showWithdrawForm() {
    const html = `Amount: <input type="number" id="withdrawAmount" value="1000000"><button onclick="requestWithdraw()">Submit</button>`;
    document.getElementById('output').innerHTML = html;
}

async function requestWithdraw() {
    const amount = document.getElementById('withdrawAmount').value;
    await fetchData('withdraw', { telegram_id: tgUser.id, amount });
    updateDashboard();
    showWithdrawHistory();
}

async function showWithdrawHistory() {
    const history = await fetchData('getWithdrawHistory', { telegram_id: tgUser.id });
    let output = '=== WITHDRAW HISTORY ===\n';
    history.forEach(w => output += `${w.timestamp} - ${w.amount} TRO - ${w.status}\n`);
    document.getElementById('output').textContent = output;
}

// 7️⃣ Auto-refresh dashboard tiap 10 detik
setInterval(updateDashboard, 10000);
</script>

</body>
</html>
