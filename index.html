<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Taro Miner</title>
<style>
body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f0f2f5; }
h2 { margin-top: 0; }
.card { background: #fff; padding: 15px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
</style>
</head>
<body>

<h2>Taro Miner Dashboard</h2>

<div class="card">
  <div>Hashrate Saya: <span id="myHashrate">--</span> H/s</div>
  <div>Hashrate Jaringan: <span id="networkHashrate">--</span> H/s</div>
  <div>Blok Saat Ini: <span id="currentBlock">--</span></div>
  <div>TRO Tertambang: <span id="minedTRO">--</span> TRO</div>
  <div>Pending Reward: <span id="pendingReward">--</span> TRO</div>
</div>

<script>
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbx9ycxcyrGVjexGxin_pH7HyEZF5dGb8r42nsnfoyfOpCEl1m0t_LcRTVBJbBno3ruB/exec';
let tgUser = { id: null, username: null };

// Ambil data Telegram WebApp
if (window.Telegram.WebApp) {
    tgUser.id = window.Telegram.WebApp.initDataUnsafe.user.id;
    tgUser.username = window.Telegram.WebApp.initDataUnsafe.user.username;
    registerUser();
}

// Registrasi user otomatis
async function registerUser() {
    try {
        await fetch(`${WEBAPP_URL}?action=registerUser&telegram_id=${tgUser.id}&username=${tgUser.username}&base_hashrate=1`);
        updateDashboard();
    } catch(err) {
        console.error(err);
    }
}

// Fungsi fetch
async function fetchData(action, params = {}) {
    const url = new URL(WEBAPP_URL);
    url.searchParams.append('action', action);
    for (const key in params) url.searchParams.append(key, params[key]);
    const res = await fetch(url);
    return res.json();
}

// Update dashboard
async function updateDashboard() {
    try {
        const user = await fetchData('getUser', { telegram_id: tgUser.id });
        const network = await fetchData('getNetworkHashrate');
        const currentBlockData = await fetchData('getCurrentBlock');
        
        document.getElementById('myHashrate').textContent = user.effective_hashrate;
        document.getElementById('networkHashrate').textContent = network.total_hashrate;
        document.getElementById('currentBlock').textContent = currentBlockData.block_number + 1;
        document.getElementById('minedTRO').textContent = user.total_claimed;
        document.getElementById('pendingReward').textContent = user.unclaimed_balance;
    } catch(err) {
        console.error(err);
    }
}

// Auto-refresh tiap 10 detik
setInterval(updateDashboard, 10000);
updateDashboard();
</script>

</body>
</html>
